<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ®µè€ƒæ™‚ç¨‹è¡¨Pro2</title>
    <style>
        /* --- 1. åŸºç¤èˆ‡ RWD ä½ˆå±€ --- */
        :root { --sidebar-bg: #fcfcfc; --main-bg: #f0f2f5; --text-color: #333; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { height: 100%; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }

        .dashboard-container { display: grid; grid-template-columns: 50% 50%; grid-template-rows: 1fr 40px; height: 100vh; }

        @media (max-width: 768px) {
            .dashboard-container { grid-template-columns: 100%; }
            .main-board { display: none; }
            .sidebar-fixed { padding-top: 60px !important; }
            #mobile-clock-header { display: flex !important; }
        }

        #mobile-clock-header {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 50px;
            background: #fff; border-bottom: 1px solid #ddd; z-index: 5000;
            justify-content: center; align-items: center; font-family: monospace; font-weight: bold; font-size: 24px; color: #333;
        }

        .panel { position: relative; padding: 25px; overflow-y: auto; transition: background 0.4s ease, color 0.4s ease; background-size: cover !important; }
        .sidebar-fixed { background: var(--sidebar-bg); border-right: 2px solid #ddd; color: var(--text-color); }
        .main-board { background: var(--main-bg); overflow: hidden; }

        /* --- 2. ä»‹é¢é®ç½©èˆ‡å‹•ç•« --- */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 9999; display: flex; justify-content: center; align-items: center; color: white; }
        #save-loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #27ae60; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .login-box { background: #fff; color: #333; padding: 40px; border-radius: 12px; width: 400px; text-align: center; }
        .login-box h2 { margin-bottom: 10px; color: #2c3e50; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        
        .btn-primary { background: #3498db; color: white; border: none; padding: 12px; border-radius: 6px; width: 100%; cursor: pointer; font-size: 16px; font-weight: bold; margin-bottom: 8px; }
        .btn-guest { background: #95a5a6; color: white; border: none; padding: 12px; border-radius: 6px; width: 100%; cursor: pointer; font-size: 14px; margin-bottom: 8px; }
        .btn-reg-mode { background: #ecf0f1; color: #2c3e50; border: 1px solid #bdc3c7; padding: 10px; border-radius: 6px; width: 100%; cursor: pointer; font-size: 14px; font-weight: bold; }

        /* --- 3. å·¥å…·åˆ—èˆ‡è¡¨æ ¼ --- */
        .toolbar { background: rgba(255,255,255,0.85); padding: 8px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 5px; flex-wrap: wrap; align-items: center; color: #333 !important; }
        .btn { padding: 5px 8px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; background: white; font-size: 12px; font-weight: bold; color: #333; }
        .btn:hover { background: #f8f9fa; }
        .btn-save { background: #27ae60 !important; color: white !important; border: none; }
        .btn-lock { background: #f39c12 !important; color: white !important; border: none; }
        .btn-picker { background: #9b59b6 !important; color: white !important; border: none; }

        .title-area { display: flex; align-items: center; gap: 8px; }
        .title-ctrl { display: flex; gap: 3px; }
        .top-account-info { margin-left: auto; font-size: 12px; font-weight: bold; opacity: 0.8; padding-right: 5px; }

        .exam-table { width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.2); table-layout: fixed; color: inherit; }
        .exam-table th, .exam-table td { border: 1px solid rgba(150,150,150,0.5); padding: 6px; text-align: center; overflow-wrap: anywhere; vertical-align: middle; position: relative; }
        .exam-table td:nth-child(1) { text-align: left; padding-left: 8px; }
        
        .resizer { position: absolute; right: 0; top: 0; width: 6px; cursor: col-resize; height: 100%; z-index: 5; }
        .energy-bar { width: 100%; height: 14px; background: rgba(0,0,0,0.1); border-radius: 7px; overflow: hidden; }
        .energy-fill { width: 100%; height: 100%; background: #4caf50; transition: width 1s, background-color 0.5s; }
        
        .mgmt-cell { display: flex !important; flex-direction: row !important; flex-wrap: nowrap !important; gap: 4px; align-items: center; justify-content: center; width: 100%; }
        
        .btn-sm { width: 26px; height: 26px; border: 1px solid #ddd; background: #fff; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: #333; position: relative; overflow: hidden; flex-shrink: 0; }
        .btn-sm input[type="color"] { position: absolute; top: -10px; left: -10px; width: 50px; height: 50px; cursor: pointer; opacity: 0; }

        /* --- 4. å°å·¥å…· --- */
        .widget { position: absolute; background: white; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); padding: 35px 15px 15px; min-width: 100px; resize: both; overflow: hidden; z-index: 10; color: #333; }
        .widget-handle { position: absolute; top: 0; left: 0; width: 100%; height: 35px; background: rgba(0,0,0,0.03); cursor: move; }
        .widget-ctrl { position: absolute; top: 6px; right: 8px; display: flex; gap: 4px; z-index: 30; }
        .btn-close { background: #ff5f56; color: white; border: none; width: 18px; height: 18px; border-radius: 50%; font-size: 10px; cursor: pointer; }

        .clock-face { fill: white; stroke: #333; stroke-width: 2; }
        .hand { transform-origin: 50px 50px; stroke-linecap: round; }
        .hand-hour { stroke: #333; stroke-width: 4; transition: transform 0.5s cubic-bezier(0.4, 2.08, 0.55, 0.44); }
        .hand-min { stroke: #666; stroke-width: 3; transition: transform 0.5s cubic-bezier(0.4, 2.08, 0.55, 0.44); }
        .hand-sec { stroke: #e74c3c; stroke-width: 1.5; }

        .widget-note { background: #fff2ab !important; border-bottom-right-radius: 30px; border: 1px solid #e6db99; }
        .widget-note::after { content: ""; position: absolute; bottom: 0; right: 0; width: 30px; height: 30px; background: linear-gradient(135deg, transparent 50%, rgba(0,0,0,0.1) 50%); pointer-events: none; }

        .widget-announce { border-left: 8px solid #e74c3c; }
        .clock-digit { font-family: monospace; font-weight: bold; text-align: center; pointer-events: none; width: 100%; }
        .style-hacker { background: #000 !important; color: #00ff00 !important; text-shadow: 0 0 5px #00ff00; border: 2px solid #333; }
        .style-hacker .clock-digit { color: #00ff00 !important; }
        
        .widget textarea { width: 100%; border: none; background: transparent; outline: none; resize: none; font-family: inherit; font-size: 16px; color: inherit; }

        /* ç´…ç¶ ç‡ˆ & æŠ½ç±¤ */
        .widget-traffic { background: #333 !important; border: 2px solid #555; display: flex; justify-content: center; align-items: center; }
        .traffic-container { display: flex; gap: 15px; justify-content: center; align-items: center; width: 100%; height: 100%; }
        .light { width: 50px; height: 50px; border-radius: 50%; background: #555; cursor: pointer; transition: all 0.3s; border: 2px solid #222; }
        .light[data-color="red"].active { background: #ff4d4d; box-shadow: 0 0 20px #ff4d4d; border-color: #fff; }
        .light[data-color="yellow"].active { background: #ffcc00; box-shadow: 0 0 20px #ffcc00; border-color: #fff; }
        .light[data-color="green"].active { background: #2ecc71; box-shadow: 0 0 20px #2ecc71; border-color: #fff; }

        .widget-picker { background: #8e44ad !important; color: white !important; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .picker-settings { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; font-size: 12px; }
        .picker-settings input { width: 40px; border-radius: 4px; border: none; padding: 2px; text-align: center; font-weight: bold; color: #333; }
        .picker-display { font-size: 60px; font-weight: bold; font-family: monospace; text-shadow: 2px 2px 0px rgba(0,0,0,0.3); margin: 5px 0; height: 70px; display: flex; align-items: center; }
        .btn-draw { border: 2px solid white; background: transparent; color: white; padding: 5px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-draw:hover { background: white; color: #8e44ad; }
        .btn-draw:disabled { opacity: 0.5; cursor: not-allowed; }

        .locked .resizer, .locked .widget-ctrl, .locked .widget-handle, .locked .mgmt-cell button, .locked .mgmt-cell label, .locked .title-ctrl { display: none !important; }
        .locked .widget { resize: none !important; }

        /* èƒŒæ™¯é¸å–® */
        .bg-menu { display: none; position: absolute; background: white; border: 1px solid #ccc; padding: 15px; border-radius: 10px; z-index: 2000; width: 340px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .bg-option-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }
        .bg-btn { width: 100%; height: 40px; border: 1px solid #ddd; cursor: pointer; border-radius: 6px; font-size: 10px; font-weight: bold; }

        .footer { grid-column: 1/3; background: #2c3e50; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; gap: 15px; position: relative;}
        
        .day-switcher { display: flex; gap: 2px; margin-right: 15px; }
        .day-btn { background: #34495e; color: #bdc3c7; border: 1px solid #34495e; padding: 4px 12px; cursor: pointer; font-size: 12px; transition: all 0.3s; border-radius: 4px 4px 0 0; margin-top: 4px; }
        .day-btn:hover { background: #3e5871; color: white; }
        .day-btn.active { background: #f39c12; color: #fff; border-color: #f39c12; font-weight: bold; transform: translateY(-2px); }
        .day-btn-copy { background: #6c5ce7; color: #ecf0f1; border-color: #6c5ce7; font-weight: bold; }
        .day-btn-copy:hover { background: #a29bfe; color: white; }

        /* æ–°å¢ï¼šFooter é€£çµæ¨£å¼èˆ‡ç‰ˆæœ¬æ¨™ç±¤ */
        .footer-link { color: #ecf0f1; text-decoration: none; border-bottom: 1px dashed #7f8c8d; transition: all 0.3s; }
        .footer-link:hover { color: #f1c40f; border-bottom: 1px solid #f1c40f; }
        .version-tag { position: absolute; left: 15px; opacity: 0.3; font-family: monospace; letter-spacing: 1px; }
    </style>
</head>
<body id="main-body">

<div id="mobile-clock-header">00:00:00</div>

<div id="save-loading">
    <div class="spinner"></div>
    <div id="loading-text">é›²ç«¯å­˜æª”ä¸­...</div>
</div>

<div id="login-overlay">
    <div class="login-box">
        <h2 id="auth-title">ç™»å…¥å„€è¡¨æ¿</h2>
        <div id="input-area">
            <input type="text" id="user-id" placeholder="å¸³è™Ÿ (æµæ°´è™Ÿ 0001)">
            <input type="password" id="user-pw" placeholder="å¯†ç¢¼">
        </div>
        <button type="button" class="btn-primary" id="auth-main-btn" onclick="window.handleAuth()">é€²å…¥ç³»çµ±</button>
        <button type="button" class="btn-guest" id="guest-btn" onclick="window.handleGuestLogin()">è¨ªå®¢ç™»å…¥</button>
        <button type="button" class="btn-reg-mode" id="auth-toggle-btn" onclick="window.toggleAuthMode()">è¨»å†Š</button>
    </div>
</div>

<div class="dashboard-container">
    <aside class="panel sidebar-fixed" id="left-panel">
        <div class="toolbar">
            <div class="title-area">
                <h2 contenteditable="true" id="db-title">æœ¬å­¸æœŸæ®µè€ƒæ™‚ç¨‹</h2>
                <div class="title-ctrl">
                    <button class="btn-sm" onclick="window.toggleTitleBold()">B</button>
                    <label class="btn-sm">A<input type="color" onchange="window.changeTitleColor(this.value)"></label>
                </div>
            </div>
            <button class="btn" onclick="window.addTableRow()">+æ–°å¢</button>
            <button class="btn" onclick="window.changeFontSize(2)">A+</button>
            <button class="btn" onclick="window.changeFontSize(-2)">A-</button>
            <button class="btn" onclick="window.openBgMenu('left', event)">ğŸ¨èƒŒæ™¯</button>
            <button class="btn btn-lock" id="btn-lock" onclick="window.toggleLock()">ğŸ”“ è§£é–ä¸­</button>
            <button class="btn btn-save" onclick="window.saveData()">ğŸ’¾å­˜æª”</button>
            <span class="top-account-info" id="top-display-id">ID: ----</span>
            <button class="btn" onclick="window.logout()">ç™»å‡º</button>
        </div>
        <table class="exam-table" id="exam-table">
            <thead>
                <tr><th id="th-1" style="width:25%">ç§‘ç›®</th><th id="th-2" style="width:20%">æ™‚é–“</th><th id="th-3" style="width:25%">èƒ½é‡æ¢</th><th id="th-4" style="width:30%">ç®¡ç†</th></tr>
            </thead>
            <tbody id="exam-tbody"></tbody>
        </table>
    </aside>

    <main class="panel main-board" id="right-panel">
        <div class="toolbar">
            <button class="btn" onclick="createWidget('digital', null, 'default')">+æ•¸ä½(ç™½)</button>
            <button class="btn" onclick="createWidget('digital', null, 'hacker')">+æ•¸ä½(é»‘ç¶ )</button>
            <button class="btn" onclick="createWidget('analog')">+æŒ‡é‡</button>
            <button class="btn" onclick="createWidget('note')">+ä¾¿åˆ©è²¼</button>
            <button class="btn" onclick="createWidget('announce')">+å…¬å‘Š</button>
            <button class="btn" style="border: 1px solid #333; background:#555; color:white;" onclick="createWidget('traffic')">ğŸš¥ç´…ç¶ ç‡ˆ</button>
            <button class="btn btn-picker" onclick="createWidget('picker')">ğŸ²æŠ½ç±¤</button>
            <button class="btn" onclick="openBgMenu('right', event)">ğŸ¨èƒŒæ™¯</button>
        </div>
    </main>

    <div id="bg-selector" class="bg-menu">
        <div class="bg-option-grid">
            <button class="bg-btn" style="background:#ffffff" onclick="window.setPanelBg('#ffffff', '#333')">ç´”ç™½</button>
            <button class="bg-btn" style="background:#f0f2f5" onclick="window.setPanelBg('#f0f2f5', '#333')">ç°¡ç´„ç°</button>
            <button class="bg-btn" style="background:#e8f5e9" onclick="window.setPanelBg('#e8f5e9', '#333')">ç²‰å«©ç¶ </button>
            <button class="bg-btn" style="background:#fff3e0" onclick="window.setPanelBg('#fff3e0', '#333')">ç²‰å«©æ©˜</button>
            
            <button class="bg-btn" style="background:linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)" onclick="window.setPanelBg('linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)', '#333')">æµ·æ´‹è—</button>
            <button class="bg-btn" style="background:linear-gradient(135deg, #f6d365 0%, #fda085 100%)" onclick="window.setPanelBg('linear-gradient(135deg, #f6d365 0%, #fda085 100%)', '#333')">æ™¨æ›¦æ©˜</button>
            <button class="bg-btn" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%)" onclick="window.setPanelBg('linear-gradient(135deg, #667eea 0%, #764ba2 100%)', '#fff')">æ·±é‚ƒç´«</button>
            <button class="bg-btn" style="background:linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)" onclick="window.setPanelBg('linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)', '#333')">è–„è·ç¶ </button>
            
            <button class="bg-btn" style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%)" onclick="window.setPanelBg('linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', '#fff')">æµªæ¼«ç²‰</button>
            <button class="bg-btn" style="background:linear-gradient(to right, #243b55, #141e30)" onclick="window.setPanelBg('linear-gradient(to right, #243b55, #141e30)', '#fff')">åˆå¤œè—</button>
            <button class="bg-btn" style="background:#2c3e50" onclick="window.setPanelBg('#2c3e50', '#fff')">æ·±éµç°</button>
            <button class="bg-btn" style="background:#fef9e7" onclick="window.setPanelBg('#fef9e7', '#333')">ç±³é»ƒç´™</button>
            
            <button class="bg-btn" style="background:#000000" onclick="window.setPanelBg('#000000', '#fff')">å…¨é»‘(AMOLED)</button>
            <button class="bg-btn" style="background:#2ecc71" onclick="window.setPanelBg('#27ae60', '#fff')">é»‘æ¿ç¶ </button>
            <button class="bg-btn" style="background:#ff9ff3" onclick="window.setPanelBg('#ff9ff3', '#333')">ç³–æœç²‰</button>
            <button class="bg-btn" style="background:#dfe6e9" onclick="window.setPanelBg('#dfe6e9', '#333')">å†·æ·¡ç°</button>
        </div>
    </div>

    <footer class="footer">
        <span class="version-tag">v.34ç‰ˆ</span>
        <div class="day-switcher">
            <button class="day-btn day-btn-copy" onclick="window.copyDayOne()" title="å°‡ç¬¬1å¤©å…§å®¹è¤‡è£½åˆ°é€™è£¡">ğŸ“¥è¤‡è£½ç¬¬1å¤©</button>
            <button class="day-btn active" id="btn-day-1" onclick="window.switchDay(1)">ç¬¬ä¸€å¤©</button>
            <button class="day-btn" id="btn-day-2" onclick="window.switchDay(2)">ç¬¬äºŒå¤©</button>
            <button class="day-btn" id="btn-day-3" onclick="window.switchDay(3)">ç¬¬ä¸‰å¤©</button>
        </div>
        <div>
            å¸³è™Ÿï¼š<span id="display-id">---</span> | 
            <a href="https://www.facebook.com/share/1K5MsceXxS/?mibextid=wwXIfr" target="_blank" class="footer-link">å¥•éˆè€å¸«è£½ä½œ</a> 
            &copy; 2026
        </div>
    </footer>
</div>

<script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwX1dAzFJPH-T0gflLIX8X2VxHBnxYs3n0oWzK8cMZTErzzTEgL9yODXUcoZ2tWead3/exec'; 

    var currentUser = { id: '', pw: '' };
    var isRegisterMode = false;
    var activePanelId = '';
    var isLocked = false;
    
    var currentDay = 1;
    var allDaysData = { 1: null, 2: null, 3: null };

    // --- 1. ç™»å…¥ç³»çµ± ---
    window.toggleAuthMode = function() {
        isRegisterMode = !isRegisterMode;
        var authTitle = document.getElementById('auth-title');
        var inputArea = document.getElementById('input-area');
        var mainBtn = document.getElementById('auth-main-btn');
        var guestBtn = document.getElementById('guest-btn');
        var toggleBtn = document.getElementById('auth-toggle-btn');

        if (isRegisterMode) {
            authTitle.innerText = "è¨­å®šæ–°å¯†ç¢¼";
            inputArea.innerHTML = '<p style="font-size:15px; color:#e67e22; margin-bottom:10px; font-weight:bold;">ç³»çµ±æœƒé…ç™¼ 4 å€‹æ•¸å­—çš„å¸³è™Ÿçµ¦ä½ </p>' +
                                '<input type="password" id="user-pw" placeholder="è«‹è¨­å®š 4 ä½æ•¸å­—å¯†ç¢¼ (å¦‚ 0523)" maxlength="4">';
            mainBtn.innerText = "ç²å–å¸³è™Ÿä¸¦ç™»å…¥";
            guestBtn.style.display = "none";
            toggleBtn.innerText = "è¿”å›ç™»å…¥";
        } else {
            authTitle.innerText = "ç™»å…¥å„€è¡¨æ¿";
            inputArea.innerHTML = '<input type="text" id="user-id" placeholder="å¸³è™Ÿ (æµæ°´è™Ÿ 0001)">' +
                                '<input type="password" id="user-pw" placeholder="å¯†ç¢¼">';
            mainBtn.innerText = "é€²å…¥ç³»çµ±";
            guestBtn.style.display = "block";
            toggleBtn.innerText = "è¨»å†Š";
        }
    };

    window.handleAuth = async function() {
        var idIn = document.getElementById('user-id');
        var pwIn = document.getElementById('user-pw');
        var idVal = idIn ? idIn.value : "";
        var rawPw = pwIn ? pwIn.value : "";
        var pwVal = rawPw.toString().padStart(4, '0');

        if (isRegisterMode && !/^\d{4}$/.test(pwVal)) { alert("å¯†ç¢¼è«‹è¨­å®šç‚º 4 ä½æ•¸å­—ï¼"); return; }
        if (!isRegisterMode && !idVal) { alert("è«‹è¼¸å…¥å¸³è™Ÿ"); return; }
        if (!rawPw) { alert("è«‹è¼¸å…¥å¯†ç¢¼"); return; }

        var btn = document.getElementById('auth-main-btn');
        btn.disabled = true; btn.innerText = "é€£ç·šä¸­...";

        try {
            var res = await fetch(GAS_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ action: isRegisterMode ? "register" : "login", userID: idVal, password: pwVal }) });
            var result = await res.json();
            if (result.success) {
                alert(result.message);
                currentUser.id = (result.userID || idVal).toString().padStart(4, '0');
                currentUser.pw = pwVal;
                document.getElementById('display-id').innerText = currentUser.id;
                document.getElementById('top-display-id').innerText = "ID: " + currentUser.id;
                document.getElementById('login-overlay').style.display = 'none';
                
                if (result.dashboardData) {
                    var parsed = JSON.parse(result.dashboardData);
                    if (parsed.multiDay === true) {
                        allDaysData = parsed.days;
                        if(!allDaysData[1]) allDaysData[1] = null;
                        if(!allDaysData[2]) allDaysData[2] = null;
                        if(!allDaysData[3]) allDaysData[3] = null;
                        var savedDay = parsed.lastActiveDay || 1;
                        switchDay(savedDay, true);
                    } else {
                        allDaysData[1] = parsed;
                        switchDay(1, true);
                    }
                } else {
                    switchDay(1, true);
                }
            } else { alert(result.message); }
        } catch (e) { console.error(e); alert("é€£ç·šå¤±æ•—ï¼"); }
        finally { btn.disabled = false; btn.innerText = isRegisterMode ? "ç²å–å¸³è™Ÿ" : "é€²å…¥ç³»çµ±"; }
    };

    window.handleGuestLogin = function() {
        currentUser.id = "è¨ªå®¢"; currentUser.pw = "";
        document.getElementById('display-id').innerText = "è¨ªå®¢ (ç„¡å­˜æª”åŠŸèƒ½)";
        document.getElementById('top-display-id').innerText = "è¨ªå®¢";
        document.getElementById('login-overlay').style.display = 'none';
        switchDay(1, true);
    };

    window.logout = function() {
        alert("æ‚¨çš„å¸³è™Ÿæ˜¯ " + currentUser.id + "ï¼Œå·²ç™»å‡º");
        location.reload();
    };

    // --- 2. å­˜å–é‚è¼¯ ---
    window.getCurrentState = function() {
        var titleEl = document.getElementById('db-title');
        var data = {
            title: titleEl.innerText, titleBold: titleEl.style.fontWeight === 'bold', titleColor: titleEl.style.color,
            leftBg: document.getElementById('left-panel').style.background, rightBg: document.getElementById('right-panel').style.background,
            panelTextColor: document.getElementById('left-panel').style.color, tableFontSize: document.getElementById('exam-table').style.fontSize,
            isLocked: isLocked,
            colWidths: [document.getElementById('th-1').style.width, document.getElementById('th-2').style.width, document.getElementById('th-3').style.width, document.getElementById('th-4').style.width],
            table: [], widgets: []
        };
        document.querySelectorAll('#exam-tbody tr').forEach(function(row) {
            data.table.push({ subject: row.cells[0].innerText, time: row.cells[1].innerText, bold: row.style.fontWeight === 'bold', color: row.style.color });
        });
        document.querySelectorAll('.widget').forEach(function(w) {
            var type = 'note';
            if (w.classList.contains('widget-digital')) type = 'digital';
            else if (w.classList.contains('widget-analog')) type = 'analog';
            else if (w.classList.contains('widget-announce')) type = 'announce';
            else if (w.classList.contains('widget-traffic')) type = 'traffic';
            else if (w.classList.contains('widget-picker')) type = 'picker';
            
            var txt = w.querySelector('textarea');
            var extra = '';
            
            if (type === 'traffic') {
                var activeLight = w.querySelector('.light.active');
                if (activeLight) extra = activeLight.dataset.color;
            } else if (type === 'picker') {
                var maxInput = w.querySelector('.picker-settings input');
                if(maxInput) extra = maxInput.value;
            } else if (w.querySelector('input')) {
                extra = w.querySelector('input').value;
            }

            data.widgets.push({ 
                type, top: w.style.top, left: w.style.left, width: w.style.width, height: w.style.height, 
                content: txt ? txt.value : '', extra: extra,
                fontSize: txt ? txt.style.fontSize : '16px', hacker: w.classList.contains('style-hacker')
            });
        });
        return data;
    }

    window.saveData = async function() {
        if (!currentUser.id || currentUser.id === "è¨ªå®¢") { alert("è¨ªå®¢ç„¡æ³•å­˜æª”ï¼"); return; }
        allDaysData[currentDay] = window.getCurrentState();
        var pack = { multiDay: true, lastActiveDay: currentDay, days: allDaysData };
        var jsonStr = JSON.stringify(pack);
        if (jsonStr.length > 45000) { alert("ç¸½è³‡æ–™é‡éå¤§ï¼Œè«‹æ¸›å°‘éƒ¨åˆ†å…§å®¹ã€‚"); return; } 

        document.getElementById('save-loading').style.display = 'flex';
        try {
            var res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: "save", userID: currentUser.id, password: currentUser.pw, dashboardData: jsonStr }) });
            var resJ = await res.json(); alert(resJ.message);
        } catch (e) { alert("å­˜æª”å¤±æ•—ã€‚"); }
        finally { document.getElementById('save-loading').style.display = 'none'; }
    };

    window.switchDay = function(dayNum, forceInit) {
        if (!forceInit && currentDay === dayNum) return;
        if (!forceInit) allDaysData[currentDay] = window.getCurrentState();

        currentDay = dayNum;
        document.querySelectorAll('.day-btn').forEach(b => {
            if(!b.classList.contains('day-btn-copy')) b.classList.remove('active');
        });
        document.getElementById('btn-day-' + dayNum).classList.add('active');

        var dataToLoad = allDaysData[dayNum];
        document.querySelectorAll('.widget').forEach(w => w.remove());
        document.getElementById('exam-tbody').innerHTML = "";

        if (dataToLoad) {
            window.renderDashboard(dataToLoad);
        } else {
            document.getElementById('db-title').innerText = "ç¬¬" + dayNum + "å¤©æ®µè€ƒæ™‚ç¨‹";
            document.getElementById('db-title').style.color = "inherit";
            document.getElementById('left-panel').style.background = "";
            document.getElementById('right-panel').style.background = "";
            window.toggleLock(false);
        }
    };

    window.copyDayOne = function() {
        if (currentDay === 1) { alert("ä½ ç›®å‰å°±åœ¨ç¬¬1å¤©ï¼Œä¸éœ€è¦è¤‡è£½ã€‚"); return; }
        if (!allDaysData[1]) { alert("ç¬¬1å¤©é‚„æ²’æœ‰å­˜æª”è³‡æ–™ï¼Œç„¡æ³•è¤‡è£½ã€‚"); return; }
        if (!confirm("ç¢ºå®šè¦å°‡ã€Œç¬¬1å¤©ã€çš„æ‰€æœ‰è¨­å®šï¼ˆç§‘ç›®è¡¨ã€èƒŒæ™¯ï¼‰è¤‡è£½è¦†è“‹åˆ°ç›®å‰é€™ä¸€å¤©å—ï¼Ÿ\n(åŸæœ¬é€™ä¸€å¤©çš„å…§å®¹æœƒæ¶ˆå¤±)")) return;
        
        var copiedData = JSON.parse(JSON.stringify(allDaysData[1]));
        window.renderDashboard(copiedData);
        alert("è¤‡è£½æˆåŠŸï¼è«‹è¨˜å¾—å­˜æª”ã€‚");
    };

    window.renderDashboard = function(data) {
        var titleEl = document.getElementById('db-title');
        titleEl.innerText = data.title || "æœ¬å­¸æœŸæ®µè€ƒæ™‚ç¨‹";
        titleEl.style.fontWeight = data.titleBold ? 'bold' : 'normal';
        titleEl.style.color = data.titleColor || 'inherit';

        document.getElementById('left-panel').style.background = data.leftBg || "";
        document.getElementById('right-panel').style.background = data.rightBg || "";
        document.getElementById('left-panel').style.color = data.panelTextColor || "inherit";
        document.getElementById('exam-table').style.fontSize = data.tableFontSize || "16px";
        if (data.colWidths) data.colWidths.forEach(function(w, i) { if(w) document.getElementById('th-' + (i+1)).style.width = w; });
        
        document.getElementById('exam-tbody').innerHTML = "";
        
        if(data.table) data.table.forEach(function(item) { window.addTableRow(item); });
        if(data.widgets) data.widgets.forEach(function(w) { createWidget(w.type, w, w.hacker ? 'hacker' : 'default'); });
        
        window.toggleLock(!!data.isLocked);
    };
    
    window.loadDashboard = function(data) { window.renderDashboard(data); };

    // --- 3. UI åŠŸèƒ½ ---
    window.toggleTitleBold = function() { var el = document.getElementById('db-title'); el.style.fontWeight = (el.style.fontWeight === 'bold' ? 'normal' : 'bold'); };
    window.changeTitleColor = function(c) { document.getElementById('db-title').style.color = c; };

    window.toggleLock = function(forceLock) {
        isLocked = (typeof forceLock === 'boolean') ? forceLock : !isLocked;
        var btn = document.getElementById('btn-lock');
        var body = document.getElementById('main-body');
        if (isLocked) {
            btn.innerText = "ğŸ”’ å·²é–å®š"; btn.style.background = "#e74c3c"; body.classList.add('locked');
            document.getElementById('db-title').contentEditable = "false";
            document.querySelectorAll('#exam-tbody td[contenteditable]').forEach(function(el) { el.contentEditable = "false"; });
            document.querySelectorAll('textarea, input:not([type="color"])').forEach(function(el) { el.readOnly = true; });
            document.querySelectorAll('.picker-settings input').forEach(function(el) { el.disabled = true; });
        } else {
            btn.innerText = "ğŸ”“ è§£é–ä¸­"; btn.style.background = "#f39c12"; body.classList.remove('locked');
            document.getElementById('db-title').contentEditable = "true";
            document.querySelectorAll('#exam-tbody td').forEach(function(el, idx) { if(idx % 4 < 2) el.contentEditable = "true"; });
            document.querySelectorAll('textarea, input:not([type="color"])').forEach(function(el) { el.readOnly = false; });
            document.querySelectorAll('.picker-settings input').forEach(function(el) { el.disabled = false; });
        }
    };

    window.addTableRow = function(data) {
        // åˆ—æ•¸é™åˆ¶æª¢æŸ¥
        var currentRows = document.querySelectorAll('#exam-tbody tr').length;
        if (currentRows >= 10) { alert("æœ€å¤šåªèƒ½æ–°å¢ 10 åˆ—ç§‘ç›®å–”ï¼"); return; }

        var tr = document.createElement('tr');
        if(data && data.bold) tr.style.fontWeight = 'bold';
        if(data && data.color) tr.style.color = data.color;
        
        tr.innerHTML = '<td>' + (data ? data.subject : 'æ–°ç§‘ç›®') + '</td><td contenteditable="true">' + (data ? data.time : '08:00-09:00') + '</td><td><div class="energy-bar"><div class="energy-fill"></div></div></td>' +
            '<td><div class="mgmt-cell"><button class="btn-sm" onclick="window.toggleRowBold(this)">B</button>' +
            '<label class="btn-sm">A<input type="color" value="' + (data?.color || '#000000') + '" onchange="this.closest(\'tr\').style.color=this.value"></label>' +
            '<button class="btn-sm" style="color:red" onclick="this.closest(\'tr\').remove()">âœ–</button></div></td>';
        var subCell = tr.cells[0]; subCell.contentEditable = "true";
        subCell.addEventListener('input', function() { if (this.innerText.length > 20) { this.innerText = this.innerText.substring(0, 20); alert("ç§‘ç›®ä¸Šé™ 20 å­—"); } });
        document.getElementById('exam-tbody').appendChild(tr);
    };

    window.toggleRowBold = function(btn) { if(isLocked) return; var r = btn.closest('tr'); r.style.fontWeight = (r.style.fontWeight === 'bold' ? 'normal' : 'bold'); };
    window.changeFontSize = function(d) { if(isLocked) return; var t = document.getElementById('exam-table'); var s = parseInt(window.getComputedStyle(t).fontSize) || 16; t.style.fontSize = (s + d) + 'px'; };
    
    // èƒŒæ™¯é¸å–®é–‹å•Ÿé‚è¼¯ä¿®æ­£ï¼šé˜²æ­¢æº¢å‡º
    window.openBgMenu = function(p, e) {
        if(isLocked) return;
        activePanelId = p + '-panel';
        var m = document.getElementById('bg-selector');
        m.style.display = 'block';
        
        // ä¿®æ­£ï¼šå¦‚æœé»æ“Šä½ç½®é å³ï¼Œé¸å–®å‘å·¦åç§»
        var menuWidth = 340;
        var xPos = e.pageX;
        if (xPos + menuWidth > window.innerWidth) {
            xPos = e.pageX - menuWidth; 
        }
        
        m.style.left = xPos + 'px';
        m.style.top = e.pageY + 'px';
        e.stopPropagation();
    };
    
    window.setPanelBg = function(s, textColor) { 
        var p = document.getElementById(activePanelId); p.style.background = s; 
        if(textColor) p.style.color = textColor; 
        document.getElementById('bg-selector').style.display = 'none'; 
    };

    // --- 4. å°å·¥å…· ---
    function createWidget(type, data, styleType) {
        if (type === 'digital' && styleType === 'default') { if (document.querySelectorAll('.widget-digital:not(.style-hacker)').length >= 1) return alert("ç™½è‰²æ•¸ä½æ™‚é˜åªèƒ½ 1 å€‹"); }
        if (type === 'digital' && styleType === 'hacker') { if (document.querySelectorAll('.style-hacker').length >= 1) return alert("é§­å®¢æ•¸ä½æ™‚é˜åªèƒ½ 1 å€‹"); }
        if (type === 'analog') { if (document.querySelectorAll('.widget-analog').length >= 1) return alert("æŒ‡é‡æ™‚é˜åªèƒ½ 1 å€‹"); }
        if (type === 'traffic') { if (document.querySelectorAll('.widget-traffic').length >= 1) return alert("ç´…ç¶ ç‡ˆåªèƒ½ 1 å€‹"); }
        if (type === 'announce') { if (document.querySelectorAll('.widget-announce').length >= 3) return alert("å…¬å‘Šæ¬„æœ€å¤š 3 å€‹"); }
        if (type === 'note') { if (document.querySelectorAll('.widget-note').length >= 3) return alert("ä¾¿åˆ©è²¼æœ€å¤š 3 å€‹"); }
        if (type === 'picker') { if (document.querySelectorAll('.widget-picker').length >= 1) return alert("æŠ½ç±¤å·¥å…·åªèƒ½ 1 å€‹"); }

        var board = document.getElementById('right-panel');
        var w = document.createElement('div');
        w.className = 'widget widget-' + type;
        if (styleType === 'hacker') w.classList.add('style-hacker');
        
        w.style.top = data?.top || '100px'; w.style.left = data?.left || '100px';
        
        if (data && data.width) {
             w.style.width = data.width; w.style.height = data.height;
        } else {
             if(type === 'digital') { w.style.width='250px'; w.style.height='120px'; }
             else if(type === 'traffic') { w.style.width='200px'; w.style.height='90px'; }
             else if(type === 'picker') { w.style.width='180px'; w.style.height='160px'; }
             else { w.style.width='220px'; w.style.height='220px'; }
        }

        var html = '<div class="widget-handle"></div><div class="widget-ctrl">';
        if (type === 'announce') { html += '<button class="btn-widget" onclick="window.zoomText(this, 2)">A+</button><button class="btn-widget" onclick="window.zoomText(this, -2)">A-</button>'; }
        html += '<button class="btn-close" onclick="this.closest(\'.widget\').remove()">Ã—</button></div>';
        
        if (type === 'digital') {
            html += '<div class="clock-digit">00:00:00</div>';
            new ResizeObserver(function(entries) { for(var entry of entries) { var digit = entry.target.querySelector('.clock-digit'); if(digit) digit.style.fontSize = (entry.target.offsetWidth / 5) + 'px'; } }).observe(w);
        } else if (type === 'analog') {
            var svg = '<svg viewBox="0 0 100 100" style="width:95%; height:95%"><circle class="clock-face" cx="50" cy="50" r="48" fill="white" stroke="#333" stroke-width="2"/>';
            for(let i=1; i<=12; i++) {
                let a = (i * 30) * (Math.PI / 180);
                svg += '<text x="' + (50+38*Math.sin(a)) + '" y="' + (50-38*Math.cos(a)) + '" style="font-size:8px;font-weight:bold;fill:#333;text-anchor:middle;dominant-baseline:middle;">'+i+'</text>';
                svg += '<line x1="'+(50+44*Math.sin(a))+'" y1="'+(50-44*Math.cos(a))+'" x2="'+(50+48*Math.sin(a))+'" y2="'+(50-48*Math.cos(a))+'" stroke="#333" stroke-width="2"/>';
            }
            svg += '<line x1="50" y1="50" x2="50" y2="28" class="hand hand-hour" /><line x1="50" y1="50" x2="50" y2="18" class="hand hand-min" /><line x1="50" y1="50" x2="50" y2="12" class="hand hand-sec" /><circle cx="50" cy="50" r="2.5" fill="#333"/></svg>';
            html += svg;
        } else if (type === 'note' || type === 'announce') {
            var fs = data?.fontSize || '16px';
            html += (type === 'announce' ? '<input value="'+(data?.extra || 'ä»Šæ—¥å…¬å‘Š')+'" style="font-weight:bold; color:#e74c3c" maxlength="20">' : '') +
                    '<textarea maxlength="200" style="height:80%; font-size:'+fs+'">'+(data?.content || '')+'</textarea>';
        } else if (type === 'traffic') {
            html += '<div class="traffic-container">' +
                    '<div class="light" data-color="red" onclick="window.toggleLight(this)"></div>' +
                    '<div class="light" data-color="yellow" onclick="window.toggleLight(this)"></div>' +
                    '<div class="light" data-color="green" onclick="window.toggleLight(this)"></div>' +
                    '</div>';
        } else if (type === 'picker') {
            html += '<div class="picker-settings">äººæ•¸: <input type="number" value="'+(data?.extra || 30)+'" min="1" max="999"></div>' +
                    '<div class="picker-display">0</div>' +
                    '<button class="btn-draw" onclick="window.runPicker(this)">æŠ½!</button>';
        }
        w.innerHTML = html; board.appendChild(w); makeDraggable(w);

        if (type === 'traffic' && data && data.extra) {
            var target = w.querySelector('.light[data-color="'+data.extra+'"]');
            if (target) target.classList.add('active');
        }
    }

    window.toggleLight = function(el) {
        if (isLocked) return;
        var parent = el.closest('.traffic-container');
        if (el.classList.contains('active')) {
            el.classList.remove('active');
        } else {
            parent.querySelectorAll('.light').forEach(l => l.classList.remove('active'));
            el.classList.add('active');
        }
    };

    window.runPicker = function(btn) {
        if (isLocked) return;
        var widget = btn.closest('.widget-picker');
        var maxVal = parseInt(widget.querySelector('input').value) || 30;
        var display = widget.querySelector('.picker-display');
        btn.disabled = true;

        var count = 0;
        var interval = setInterval(function() {
            display.innerText = Math.floor(Math.random() * maxVal) + 1;
            count++;
            if (count > 20) {
                clearInterval(interval);
                btn.disabled = false;
                var finalNum = Math.floor(Math.random() * maxVal) + 1;
                display.innerText = finalNum;
                display.style.color = '#f1c40f';
                setTimeout(() => display.style.color = '', 1000);
            }
        }, 80);
    };

    window.zoomText = function(btn, d) { var txt = btn.closest('.widget').querySelector('textarea'); var s = parseInt(window.getComputedStyle(txt).fontSize) || 16; txt.style.fontSize = (s + d) + 'px'; };

    function makeDraggable(el) {
        var h = el.querySelector('.widget-handle');
        h.addEventListener('mousedown', function(e) {
            if (isLocked) return;
            var ox = e.clientX - el.offsetLeft, oy = e.clientY - el.offsetTop;
            document.querySelectorAll('.widget').forEach(function(w) { w.style.zIndex = 10; }); el.style.zIndex = 100;
            const move = function(ev) { el.style.left = (ev.clientX - ox) + 'px'; el.style.top = (ev.clientY - oy) + 'px'; };
            const stop = function() { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', stop); };
            document.addEventListener('mousemove', move); document.addEventListener('mouseup', stop);
        });
    }

    // --- 5. å¾ªç’°æ›´æ–°èˆ‡åˆå§‹åŒ– ---
    function initResizableTable() {
        document.querySelectorAll('th').forEach(function(th) {
            var resizer = document.createElement('div'); resizer.className = 'resizer'; th.appendChild(resizer);
            resizer.addEventListener('mousedown', function(e) {
                if (isLocked) return;
                var startX = e.pageX, startW = th.offsetWidth;
                var mm = function(ev) { th.style.width = (startW + (ev.pageX - startX)) + 'px'; };
                var mu = function() { document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); };
                document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu);
            });
        });
    }

    setInterval(function() {
        var now = new Date();
        var timeStr = now.toTimeString().split(' ')[0];
        document.querySelectorAll('.clock-digit').forEach(function(c) { c.innerText = timeStr; });
        document.getElementById('mobile-clock-header').innerText = timeStr;

        document.querySelectorAll('.widget-analog').forEach(clock => {
            const h = now.getHours() % 12, m = now.getMinutes(), s = now.getSeconds();
            const hDeg = (h * 30) + (m / 2);
            const mDeg = (m * 6);
            const sDeg = (s * 6);
            clock.querySelector('.hand-hour').style.transform = `rotate(${hDeg}deg)`;
            clock.querySelector('.hand-min').style.transform = `rotate(${mDeg}deg)`;
            clock.querySelector('.hand-sec').style.transform = `rotate(${sDeg}deg)`;
        });

        document.querySelectorAll('#exam-tbody tr').forEach(function(row) {
            try {
                var times = row.cells[1].innerText.split('-');
                if(times.length < 2) return;
                var sArr = times[0].split(':'), eArr = times[1].split(':');
                var st = new Date(), et = new Date(); st.setHours(sArr[0], sArr[1], 0); et.setHours(eArr[0], eArr[1], 0);
                var p = 100; if (now > et) p = 0; else if (now > st) p = ((et - now) / (et - st)) * 100;
                var fill = row.querySelector('.energy-fill');
                if(fill) { fill.style.width = p + '%'; fill.style.backgroundColor = p > 50 ? '#4caf50' : (p > 20 ? '#ffeb3b' : '#f44336'); }
            } catch(e) {}
        });
    }, 1000);

    window.onclick = function() { var m = document.getElementById('bg-selector'); if(m) m.style.display='none'; };
    initResizableTable();
</script>
</body>
</html>